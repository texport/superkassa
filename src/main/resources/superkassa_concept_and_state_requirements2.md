
# SuperKassa — архитектура и требования (концепт + гос. требования)

Версия: v0.1 (синтез концепта SuperKassa + требований из CSV)

## 1. Кто такой “разработчик”
**Разработчик = клиент API SuperKassa** (банк/ERP/POS/маркетплейс/приложение), который:
- регистрирует ККМ через ОФД и налоговую (внешний процесс),
- подключает ККМ к SuperKassa,
- выполняет фискальные операции (чеки/смены/отчёты) через стабильный `cashbox_id` SuperKassa.

---

## 2. Режимы поставки (Deployment modes)

### 2.1 Desktop
- Установка на ПК, 1 экземпляр приложения.
- ККМ: много на один инстанс (ограничение — ресурсы ПК).
- Хранилище: SQLite.
- API: localhost (HTTP или локальный IPC).

### 2.2 Library (SDK)
- SuperKassa встраивается как библиотека.
- **Библиотека не “навязывает” БД**, но может иметь default SQLite-provider.
- Интегратор может подменить `StoragePort` на свой (важно для банковских приложений).

### 2.3 PowerMove (Server/Cluster)
- SuperKassa как сервис(ы) + общая БД (PostgreSQL/MySQL).
- Горизонтальное масштабирование.
- Обязателен принцип: **1 касса = 1 активная фискальная операция** (lock/lease).

---

## 3. Упрощённая архитектура (без переусложнения)

> Внутри репозитория это могут быть модули Gradle/Maven или пакеты — важно разделение ответственности, а не количество артефактов.

### 3.1 `superkassa-core`
**Фискальная логика без IO**:
- состояния кассы/смены (FSM),
- формирование документов: чеки, X/Z, отчёты,
- счётчики и математика,
- правила 7 секунд / автономный режим / 72 часа,
- генерация **автономного фискального признака**,
- правила допустимости операций (например PROGRAMMING только при закрытой смене).

### 3.2 `superkassa-storage`
**Данные, целостность, очереди и фискальный накопитель (NFD)** — это самый “жёсткий” слой, поэтому его имеет смысл писать первым.

#### 3.2.1 Цели слоя хранения
`superkassa-storage` должен:
- одинаково работать в **Desktop (SQLite)**, **PowerMove (PostgreSQL/MySQL)** и **Library (через StoragePort)**;
- обеспечивать **неизменяемость** фискальных данных (append-only ledger) и их проверяемую целостность (hash-chain) — требования **2.3, 9, 13, 43.2–43.4**;
- хранить **все OFD запросы/ответы** (request всегда, response опционально), попытки, ошибки — требования аудита/восстановления;
- обеспечивать работу **очередей** (online/offline) и **локов** (1 касса = 1 активная фискальная операция) — требования **30.2, 30.3** и правила последовательной выгрузки;
- хранить и обновлять чувствительные данные (токены) **только в шифрованном виде**.

#### 3.2.2 Границы ответственности (что хранение делает / не делает)
**Делает:**
- SQL-миграции и схемы таблиц (SQLite/PG/MySQL);
- транзакции, блокировки, консистентность;
- CRUD/выборки через DAO/Repository;
- сериализация/десериализация бинарных OFD payload (BLOB/base64);
- append-only запись фискальных событий и вычисление `this_hash`;
- проверка/скан целостности данных по запросу selftest (без бизнес-решений).

**Не делает:**
- не решает “уходить в автономку” и “7 секунд” — это `superkassa-core`;
- не делает сетевые вызовы к ОФД;
- не вычисляет налоги/итоги — это CounterEngine в core.

#### 3.2.3 Структура артефакта (как хранить SQL)
Рекомендуемая структура репозитория:

```
superkassa-storage/
  src/main/kotlin/...   # DAO/Repositories, Tx, Mappers, Ports
  src/main/resources/sql/
    sqlite/             # runtime-queries (если нужны разные)
    postgres/
    mysql/
superkassa-storage-migrations/
  src/main/resources/migrations/
    sqlite/V0001__init.sql
    postgres/V0001__init.sql
    mysql/V0001__init.sql
```

- **Миграции** лежат отдельно (только DDL/DML схемы).
- **Runtime SQL** (если используешь plain JDBC) — в `resources/sql/...`.
- Если выберешь jOOQ/Exposed — runtime SQL может быть в коде, но миграции всё равно отдельными файлами.

#### 3.2.4 Порт хранения (для Library режима)
Library-режим требует интерфейс, чтобы интегратор мог подменить БД:

```kotlin
interface StoragePort {
  fun <T> tx(block: () -> T): T
  val cashboxes: CashboxRepository
  val shifts: ShiftRepository
  val receipts: ReceiptRepository
  val ofdMessages: OfdMessageRepository
  val queue: QueueRepository
  val ledger: FiscalLedgerRepository
  val counters: CounterRepository
  val locks: LockRepository
}
```

Desktop/PowerMove дают дефолтную реализацию этого порта.

#### 3.2.5 Обязательные сущности хранения (минимальная схема)
Ниже — минимальный набор таблиц (унифицированный для SQLite/PG/MySQL).  
Типы:
- UUID хранить как `TEXT` (SQLite) / `UUID` (PG) — допускается адаптация.
- Время хранить как ISO-8601 `TEXT` или `TIMESTAMP` в зависимости от СУБД.

**(A) Cashboxes / Drafts**
- `cashbox_drafts` — черновики заводского номера и года выпуска.
- `cashboxes` — зарегистрированные кассы (ofd_provider, rnm, system_id, token_enc, state, last_z...).

**(B) Shifts / Reports**
- `shifts` — смены, контроль 24 часа (REQ 14).
- `z_reports`, `x_reports` — документы отчётов (payload_json + контрольные хеши).

**(C) Receipts**
- `receipts`, `receipt_items`, `receipt_payments`.
- обязательный `idempotency_key` (защита от дублей на уровне API).

**(D) OFD messages**
- `ofd_messages` (или `ofd_commands`) — хранить:
  - `command_type`
  - `request_bin` (BLOB/base64) — всегда
  - `response_bin` — nullable
  - `status`, `attempt`, `error_code`, `sent_at`, `ack_at`
- это база для ретраев, аудита, selftest/диагностики.

**(E) Queue**
- `queue_tasks`:
  - `lane = ONLINE|OFFLINE`
  - `task_type` (SEND_TICKET, SEND_Z, SEND_OFFLINE_NOTICE, etc.)
  - `ref_id` (receipt_id / z_id / message_id)
  - `next_run_at`, `attempt`, `locked_by`, `locked_until`
- offline lane должен сохранять **строгий порядок** (created_at/sequence).

**(F) Locks (PowerMove)**
- `cashbox_locks`:
  - `cashbox_id`, `locked_by`, `locked_until`
- гарантия “1 касса = 1 активная операция”.

**(G) Fiscal ledger (НФД / append-only)**
- `fiscal_events`:
  - `event_type` (RECEIPT, Z_REPORT, SHIFT_OPEN, SETTINGS_CHANGE, OFFLINE_NOTICE…)
  - `payload_json` (канонический JSON)
  - `prev_hash`, `this_hash`
  - `occurred_at`
- правило: **никаких UPDATE/DELETE** для фискальных событий (REQ 43.2).

#### 3.2.6 Hash-chain и контрольные суммы (для selftest)
Хранение обязано поддержать проверки из REQ **2.3** и **13**:

- При закрытии смены (Z):
  1) сформировать контрольную сумму Z (в payload Z-отчёта);
  2) сформировать/обновить “общую контрольную сумму всех записей” (как агрегат или как вершину hash-chain);
  3) запустить сверку:
     - “все чеки последней смены” ↔ контрольная сумма Z;
     - “общая сумма записей” ↔ сумма контрольных записей Z (как требует CSV).

Практически:
- `fiscal_events` даёт непрерывную цепочку.
- В `z_reports` хранить `fiscal_hash` (снимок вершины цепочки на момент закрытия смены).
- Selftest сверяет вершины и подмножества.

#### 3.2.7 Токены и секреты (шифрование at-rest + кэш в памяти)
Требование проекта: токен может меняться, должен жить в памяти, но храниться безопасно.

Решение:
- В БД хранить `ofd_token_enc` (AES-GCM), `key_id` (для ротации ключей).
- В рантайме держать `ActiveTokenCache`:
  - key: `cashbox_id`
  - value: `token`, `loaded_at`, `expires_at` (TTL)
- При обновлении токена в режиме PROGRAMMING:
  - `storage.cashboxes.updateTokenEnc(...)`
  - `ActiveTokenCache.invalidate(cashbox_id)`.

#### 3.2.8 Хранение покупательской доставки (печать/email/sms)
Хранилищу достаточно сохранять:
- факт “чек сформирован”
- каналы доставки и результаты (для диагностики/повторной отправки):
  - таблица `delivery_attempts`:
    - `receipt_id`, `channel`, `address/phone`, `status`, `attempt`, `error`, `created_at`

Это позволит:
- печатать повторно,
- повторить email/sms,
- показывать в UI историю.

#### 3.2.9 Индексы и производительность (минимум)
Обязательные индексы:
- `receipts(cashbox_id, created_at)` и `receipts(cashbox_id, idempotency_key)` unique
- `queue_tasks(status, next_run_at, priority)`
- `fiscal_events(cashbox_id, occurred_at)`
- `ofd_messages(cashbox_id, status, created_at)`
- `shifts(cashbox_id, state)`.

#### 3.2.10 Тесты хранения (что написать сразу)
- миграции: поднять пустую БД → применить миграции → smoke queries
- ledger: append 1000 событий → verify chain
- offline queue: записать 100 задач → воркер выбирает строго по порядку
- idempotency: второй вызов с тем же ключом возвращает тот же receipt_id
- token: encrypt/decrypt roundtrip + ротация key_id.



### 3.3 `superkassa-ofd-manager` (НЕ отдельная библиотека, а сервис/менеджер внутри)
Использует твои библиотеки:
- `ofd-kt-proto`
- `ofd-proto-codec`
- `ofd-network-client`

Отвечает за:
- выполнение команд ОФД:
  `command_info`, `command_system`, `command_report`, `command_close_shift`,
  `command_ticket`, `command_nomenclature`, `command_money_placement`,
- сетевые вызовы, таймауты транспорта,
- нормализацию ошибок.

**Не решает** автономный режим и 7 секунд — это правило ядра.

### 3.4 `superkassa-queue`
- очередь команд (per cashbox),
- автономная очередь (offline lane),
- retry/backoff,
- строгая последовательность выгрузки автономных чеков после восстановления связи.

### 3.5 `superkassa-delivery`
Доставка “покупательского” чека:
- печать,
- email,
- sms.
Core возвращает `ReceiptDocument + DeliveryPayload`, а каналы доставки — адаптеры.

---

## 4. Реестр поддерживаемых ОФД (provider registry)

Внутри SuperKassa должен быть **каталог ОФД** (подключаются по мере интеграции):

### 4.1 Модель
- `provider_code` (enum/string)
- `name`
- `environments`: `DEV`, `TEST`, `PROD`
- в каждом окружении до **3 площадок** (endpoints):
  - `host` (ip/domain)
  - `port`
  - `priority` (1..3)
  - `enabled`

### 4.2 Поведение
- выбор площадки: по приоритету, с failover, с health/latency статистикой,
- возможность override (в настройках кассы) — но только в режиме PROGRAMMING.

---

## 5. Документы и операции кассы

### 5.1 Чеки
- продажа
- возврат продажи
- покупка
- возврат покупки

### 5.2 Отчёты
- X-отчёт
- Z-отчёт (закрытие смены)
- отчёт по секциям
- отчёт по пользователям
- отчёт по операторам

### 5.3 Команды ОФД (минимальный обязательный набор)
- `command_system`
- `command_info`
- `command_report`
- `command_close_shift`
- `command_ticket`
- `command_nomenclature`
- `command_money_placement`

---

## 6. Хранение запросов/ответов ОФД и токенов

### 6.1 OFD messages
В БД хранить:
- `request_bin` (всегда)
- `response_bin` (nullable — если не доставлено/не получено)
- статус отправки/получения
- timestamps, attempt, error_code

Это нужно для:
- повторной отправки,
- аудита,
- selftest/сверок,
- диагностики.

### 6.2 OFD token
- в БД: только **зашифрованно**
- в памяти: кэш “активного токена” (обновляемый без рестарта)
- API/настройка: “обновить токен” в режиме PROGRAMMING

---

## 7. Автономный режим и автономная очередь (правила)

### 7.1 Правило 7 секунд
Если касса не получила подтверждение от ОФД в течение **7 секунд**:
- чек считается выданным в **автономном режиме**,
- печатается/отправляется покупателю с пометкой **«Автономный»**,
- создаётся **автономный фискальный признак** (генерирует касса),
- запись уходит в **offline queue**.

### 7.2 Ограничение 72 часа
Автономный режим может длиться непрерывно до 72 часов.
После восстановления связи:
- отправить сообщение о длительности автономного режима,
- затем **последовательно** выгрузить накопленные автономные чеки/данные.

### 7.3 Последовательность
Offline lane обрабатывается строго в порядке формирования (receipt_no / created_at).
Для каждой кассы — исключить параллельные фискальные операции (lock/lease).

---

## 8. Сценарии работы интегратора (Developer flow)

### 8.1 Подключение кассы через Draft
1) `createDraft()` → получить `factory_number` и `manufacture_year`
2) регистрация через ОФД/налоговую (вне SuperKassa)
3) `addCashbox()` с полными данными (ОФД, рег.номер, system_id, token)
4) SuperKassa выполняет `command_system` → `command_info`, подтягивает сервисные поля + последний Z,
   инициализирует счётчики, возвращает `cashbox_id`.

### 8.2 Подключение кассы без Draft (импорт)
- `importCashbox(factory_number, year, ofd...)`
- обязательный `command_info` и восстановление от последнего Z.

### 8.3 Продажа/чек
- `createReceipt(...)` с idempotency_key
- попытка онлайн до 7 секунд → иначе офлайн + автономная очередь
- возврат `ReceiptDocument + DeliveryPayload` → печать/email/sms

---

## 9. Место в коде: где “твои 3 ofd-либы”
Твои библиотеки остаются “низким уровнем”, а в SuperKassa появляется менеджер:
- `OfdCommandManager` (сервис внутри приложения), который:
  - собирает команды через `ofd-proto-codec`,
  - отправляет через `ofd-network-client`,
  - парсит через `ofd-kt-proto`,
  - отдаёт в core доменный результат/ошибку.

---


---

# 10. Полный перечень требований из CSV (без исключений)

## Общие требования
### Раздел 1. Требования к контрольно-кассовым машинам с функцией фиксации и передачи данных
- **1.** Иметь программный пароль (не менее четырех разрядов) или номерные ключи.
  - Программными паролями должны защищаться, как минимум, следующие режимы работы ККМ:
- **1.1** 1) режим регистрации продаж;
- **1.2** 2) режим программирования;
- **1.3** 3) режим "Закрытие смены".
- **2.** Иметь функционал автоматического тестирования при включении ККМ в работу в начале смены, а также в конце смены при снятии суточного Z-отчета.
  - Функционал должен включать в себя:
- **2.1** Тестирование основных блоков и узлов.
- **2.2** Тестирование программного обеспечения ККМ.
- **2.3** Тестирование и контроль целостности данных сохраненных в накопителе фискальных данных путем:
  - 1) проверки информации о всех выданных чеках за последнюю смену и сверки с контрольной суммой последнего Z-отчета;
  - 2) сопоставления общей контрольной суммы всех записей в накопителе фискальных данных с суммой контрольных записей всех Z-отчетов.
- **2.4** Тестирование связи с сервером оператора фискальных данных (путем отправки тестового сообщения и получения ответа).
- **3.** Обеспечивать блокирование ККМ в случае отрицательного прохождения автоматического тестирования:
- **3.1** При тестировании основных блоков и узлов.
- **3.2** При тестировании программного обеспечения ККМ.
- **3.3** При тестировании и контроле целостности данных сохраненных в накопителе фискальных данных
- **4.** Подключаться к серверу оператора фискальных данных по телекоммуникационной сети оператора фискальных данных по каналу VPN, используя протокол соединения Transmission Control Protocol/Internet Protocol (TCP/IP) и согласно протоколу передачи данных с ККМ на сервер оператора фискальных данных*
- **5** Обеспечивать оформление чека ККМ и передачу данных чека на сервер оператора фискальных данных в едином рабочем цикле при регистрации покупки (продажи).
- **6.** Обеспечивать блокирование проведения операций, в случае отсутствия или обрыва чековой ленты, неправильного выполнения операции кассиром и при возникновении других проблем в работе ККМ, приведших к невозможности выдачи кассиром чека ККМ покупателю.
- **7.** Иметь возможность подключения сканера штрих кода для считывания идентификатора маркировки товара
- **7.1** Обеспечить контроль за проведением операции при сканировании и распознавании штрих-кодов маркированной продукции, предусматривающий недопущение оформления операции в случае наличия обязательного идентификатора маркировки товара
- **8.** Обеспечивать сохранность информации о чеках ККМ, накопленных за период работы ККМ в автономном режиме в накопителе фискальных данных ККМ до момента передачи на сервер оператора фискальных данных (далее - ОФД). Автономный режим работы ККМ действует при отсутствии доступа к каналам связи и до момента отправки информации о денежных расчетах на сервер оператора фискальных данных.
- **9.** В ККМ должен быть предусмотрен режим проверки сохранности информации в накопителе фискальных данных ККМ путем формирования контрольных сумм каждой записи и общей контрольной суммы всех записей с проведением периодической их контрольной сверки (при включении ККМ и при снятии Z-отчета).
- **10.** Обеспечивать программирование (конфигурирование) основных режимов работы:
  - 1) режим регистрации (продаж, регистрации возвратов, начисления налогов); режим X и Z отчетов;
  - 2) режим программирования (просмотр/изменение настроек ККМ, настройка ККМ с внешними устройствами);
  - 3) дополнительные режимы (установка времени во внутренних часах ККМ, режим тестирования ККМ).
- **11.** Обозначения на клавиатуре и информация, выводимая на индикацию, должны быть на казахском и/или русском языках. _(примечание: Данное требование не распространяется на ККМ, являющиеся фискальными регистраторами)_
- **12.** ККМ должна обеспечивать проведение процедуры закрытия смены и формирования сменного (суточного) отчета (Z отчета).
- **13.** При формировании сменного (суточного) отчета (Z отчета) ККМ должна быть сформирована контрольная сумма данного Z отчета и общая контрольная сумма всех записей и запущена процедура контроля целостности данных сохраненных в накопителе фискальных данных в соответствии с пунктом 2.3 настоящих требований.
- **14.** ККМ должна контролировать продолжительность смены.
  - Моментом начала отсчета продолжительности смены считается окончание оформления первого платежного документа за смену.
  - В случае превышения продолжительности смены более 24 часов, ККМ должна блокировать возможность оформления платежных документов до проведения операции закрытия смены.
- **15.** ККМ обеспечивает проведение процедуры возврата чека ККМ и формирования соответствующего сообщения на сервер оператора фискальных данных.
- **16.** ККМ обеспечивает блокировку работы при получении от сервера оператора фискальных данных сообщения с требованием о приостановлении операций по кассе, выставленным органами государственных доходов.
- **17.** ККМ обеспечивает вывод сообщений, получаемых от сервера оператора фискальных данных, с уведомлениями, сформированными органами государственных доходов. Сообщения выводятся на экран ККМ или печатаются на чековой ленте при получении от сервера оператора фискальных данных.
- **Требования к работе с сервером оператора фискальных данных**
- **18.** ККМ должна поддерживать, не менее двух независимых каналов приема передачи данных.
- **19.** ККМ, включенная в Государственный реестр ККМ до 1 июля 2015 года, после модернизации поддерживает один или более независимых каналов приема передачи данных.
  - Модернизация - приведение старой модели ККМ в соответствие с новыми требованиями и нормами, техническими условиями.
- **20.** Проводить авторизацию ККМ на сервере оператора фискальных данных, согласно порядку, описанному в протоколе передачи данных с ККМ на сервер оператора фискальных данных.
- **21.** Передавать данные о совершаемых кассовых операциях на сервер оператора фискальных данных, согласно протоколу передачи данных с ККМ на сервер оператора фискальных данных.
- **22.** Передавать данные о совершаемых операциях закрытия смены и формирования Z-отчетов на сервер оператора фискальных данных, согласно протоколу передачи данных с ККМ на сервер оператора фискальных данных.
- **23.** Получать фискальный признак от сервера оператора фискальных данных.
- **24.** Печатать кассовый чек с фискальным признаком, полученным от сервера оператора фискальных данных. Требования к содержанию чека установлены Правилами применения контрольно-кассовых машин и перечень требований к содержанию чека контрольно-кассовой машины согласно к настоящему приказу.
  - Печатать в чеке ККМ по требованию покупателя (клиента), получателя товаров, работ, услуг идентификационный номер покупателя (клиента) получателя
  - Чек ККМ может дополнительно содержать данные, предусмотренные технической документацией, в том числе сведения реквизитов платежной карточки и (или) мобильного платежа.
- **25.** Время приема-передачи данных на сервер оператора фискальных данных (время формирования чека после завершения оператором процедур ввода информации об оформлении чека) должно быть не более 7 секунд.
- **26.** Обеспечивать формирование чеков и печать чеков в условиях временной потери соединения с сервером оператора фискальных данных (перехода ККМ в автономный режим работы).
- **27.** ККМ обеспечивает передачу на сервер оператора фискальных данных информации по внесению наличности в кассу и изъятию наличности из кассы
- **Требования к работе в условиях временной потери соединения с сервером**
- **28.** ККМ должна иметь накопитель фискальных данных, обеспечивающий формирование фискального признака в автономном режиме, запись, систематизацию, накопление, хранение фискальных данных в неизменном виде без потребления энергии от источников питания в течение не менее 1 месяца (720 часов) с даты записи для последующей передачи на сервер оператора фискальных данных. Накопитель фискальных данных включает в себя фискальную и оперативную память ККМ.
- **29.** При временном отсутствии соединения с сервером оператора фискальных данных или при задержках в канале передачи данных сверх допустимой величины (5 секунд на получение ответа от сервера оператора фискальных данных), а также при отсутствии электропитания, достаточного для связи с сервером оператора фискальных данных ККМ:
- **29.1** 1) переходит в автономный режим работы ККМ
- **29.2** 2) сообщает оператору-кассиру о том, что нет доступа к серверу оператора фискальных данных, и что ККМ перешла в автономный режим;
- **29.3** 3) присваивает чеку собственный уникальный номер - автономный фискальный признак.
  - Собственный уникальный номер чека должен быть уникален в течение всего срока эксплуатации ККМ.
- **29.4** 4) печатает автономный фискальный признак на чеке;
- **29.5** 5) на печатаемых чеках должна быть пометка, что устройство работает в автономном режиме:
  - Указан термин "Автономный";
- **29.6** 6) блокирует ККМ при работе в автономном режиме более 72 часа, с информированием кассира-оператора (самый "старый" автономный чек не должен быть старше 72 часов).
- **29.7** 7) ККМ в автономном режиме работы обеспечивает проведение процедуры "Закрытие смены" с печатью Z-отчета.
  - ККМ должна добавлять запрос на закрытие смены в автономную очередь и передавать его на сервер при восстановлении связи с добавлением метки с датой и временем снятия Z-отчета.
  - В случае отсутствия связи с сервером оператора фискальных данных, Z-отчет должен генерироваться на ККМ на основании данных о проведенных денежных операциях и выданных чеках, хранящихся в накопителе фискальных данных ККМ.
- **30.** При восстановлении связи с сервером оператора фискальных данных ККМ должна выполнить следующие действия:
- **30.1** 1) сформировать и передать на сервер оператора фискальных данных сообщение с информацией о продолжительности работы в автономном режиме;
- **30.2** 2) отправить последовательно на сервер оператора фискальных данных все контрольные чеки ККМ и метки о закрытиях смен (Z-отчетах), накопленные во время работы ККМ в автономном режиме, получая на каждый из них ответ от сервера оператора фискальных данных в соответствии с протоколом передачи данных с ККМ на сервер оператора фискальных данных;
- **30.3** 3) в каждом сообщении в соответствующем поле должен присутствовать автономный фискальный признак контрольного чека, присвоенный ККМ во время автономной работы (поле "Автономный фискальный признак контрольного чека") или метка работы в автономном режиме (поле метки работа в автономном режиме) согласно протоколу передачи данных с ККМ на сервер оператора фискальных данных.
- **Требования к чекам и иным документам, формируемым ККМ**
- **31** ККМ должна обеспечивать печать следующих документов:
- **31.1** 1) чек ККМ;
- **31.2** 2) отчет по кассирам;
- **31.3** 3) отчет по секциям;
- **31.4** 4) отчет без гашения (X-отчет).
  - При наличии связи с сервером оператора фискальных данных X-отчет передается на печать с сервера, при отсутствии соединения с сервером оператора фискальных данных отчет генерируется на ККМ на основании данных счетчиков, хранящихся в накопителе фискальных данных ККМ;
- **31.5** 5) сменный (суточный) отчет (Z-отчет).
  - Сменный (суточный) отчет формируется на сервере оператора фискальных данных по запросу с ККМ и передается на ККМ отдельным документом для печати.
  - В случае отсутствия связи с сервером оператора фискальных данных, Z-отчет генерируется на ККМ на основании данных о проведенных денежных операциях и выданных чеках, хранящихся в накопителе фискальных данных ККМ.
  - "Получение отчетов - Z-отчет, X-отчет" согласно протоколу передачи данных с ККМ на сервер оператора фискальных данных.
- **32.** ККМ должна обеспечивать печать реквизитов в контрольном чеке ККМ на казахском и руском языках согласно пункту 56 Правил применения контрольно-кассовых машин и перечень требований к содержанию чека контрольно-кассовой машины к настоящему приказу.
- **33.** ККМ обеспечивает возможность формирования на чеке QR-кода для автоматизированной проверки подлинности чека на интернет-ресурсе уполномоченного органа.
- **34.** QR-код должен содержать:
  - URL на данный чек, который включает:
  - 1) фискальный признак, полученный с сайта оператора фискальных данных или в автономном режиме сформированный ККМ;
  - 2) регистрационный номер ККМ в органах государственных доходов;
  - 3) дату и время формирования чека ККМ;
  - 4) итоговую сумму чека ККМ.
- **35.** Формат строки формирования QR-кода должен соответствовать следующей маске: Протокол://URL?i=Фискальный признак&f=РНМ&s=сумма тенге.тиын&t=датаTвремя.
- **36..** Размер и качество формируемого QR-кода устанавливаются согласно разделам 9 и 10 стандарта СТ РК ISO IEC 18004-2017, и зависят от технических возможностей ККМ.
- **Требования к режиму работы и порядку передачи фискальных данных на сервер**
- **37.** Порядок подключения ККМ к серверу фискальных данных должен быть указан в эксплуатационной документации на конкретную модель ККМ.
- **38.** Режим работы ККМ (как режим с передачей данных на сервер оператора фискальных данных, так и автономный при отсутствии связи с сервером) должен обеспечивать работу ККМ в полном соответствии с эксплуатационной документацией.
- **39.** Все документы, оформленные ККМ (как в режиме с передачей данных на сервер оператора фискальных данных, так и автономном при отсутствии связи с сервером), должны иметь отличительный признак фискального режима (словосочетание "Фискальный чек"), выводимый на печать только после получения номера контрольного чека от сервера оператора фискальных данных или формирования ККМ автономного фискального признака, в случае отсутствия соединения с сервером оператора фискальных данных.
- **40.** ККМ должна обеспечивать ввод следующих данных:
- **40.1** 1) адреса и порта для работы с сервером оператора фискальных данных;
- **40.2** 2) регистрационного номера ККМ в органах государственных доходов (не менее 12 знаков);
- **40.3** 3) идентификационного номера ККМ;
- **40.4** 4) первичного инициализационного токена (числовой код, сгенерированный сервером оператора фискальных данных для защиты от несанкционированного вмешательства в обмен данными);
- **40.5** 5) управление приоритетом выбора канала приема-передачи, ввод настроек параметром используемых каналов связи.
- **41.** Операции программирования (конфигурирования) подключения ККМ к серверу оператора фискальных данных (за исключением ввода токена) и коррекции даты и времени могут проводиться на ККМ только после завершения операции закрытия смены.
  - До этого момента проведение данных операций должно блокироваться.
- **42.** При проведении операции программирования даты и времени ККМ должна контролировать и запрещать ввод значений меньших, чем дата и время последнего сформированного фискального документа.
- **Требования к программному обеспечению для ККМ**
- **43.** Наряду с полной реализацией функций в соответствии с техническими требованиями исключать возможность:
- **43.1** 1) несанкционированного производителем изменения программной части ККМ;
- **43.2** 2) внесения корректировок в данные контрольных чеков, сохраненных в накопителе фискальных данных;
- **43.3** 3) вывода на документы отличительного признака фискального режима без получения номера контрольного чека от сервера оператора фискальных данных или без формирования ККМ автономного кода, в случае отсутствия соединения с сервером оператора фискальных данных;
- **43.4** 4) изменения фискального признака, полученного от сервера оператора фискальных данных, а также автономного фискального признака присвоенного чеку ККМ в автономном режиме работы.
